<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BF Outdoor Services • Pool Maintenance Checklist</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220;
      --line:rgba(255,255,255,.12);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.72);
      --ok:#22c55e;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --r:18px;
      --r2:14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 15% -10%, rgba(59,130,246,.35), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(34,197,94,.20), transparent 55%),
        radial-gradient(1200px 700px at 50% 110%, rgba(251,191,36,.14), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1280px; margin:22px auto; padding:0 14px 44px;}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px; border:1px solid var(--line); border-radius:var(--r);
      background:linear-gradient(180deg, rgba(18,27,46,.92), rgba(15,23,42,.88));
      box-shadow:var(--shadow);
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:260px}
    .mark{
      width:48px; height:48px; border-radius:14px;
      border:1px solid var(--line); background:rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      font-weight:950; letter-spacing:.6px;
    }
    .title h1{font-size:18px; margin:0; letter-spacing:.2px}
    .title p{margin:3px 0 0; font-size:12px; color:var(--muted)}
    .actions{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end}
    button,.btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:850;
      font-size:13px;
      letter-spacing:.2px;
      transition:transform .05s ease, background .2s ease;
      user-select:none;
    }
    button:hover{background:rgba(255,255,255,.10)}
    button:active{transform:translateY(1px)}
    .primary{
      background:linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.92));
      border-color:rgba(59,130,246,.45);
    }
    .success{
      background:linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.92));
      border-color:rgba(34,197,94,.45);
    }
    .danger{
      background:linear-gradient(180deg, rgba(239,68,68,.92), rgba(220,38,38,.92));
      border-color:rgba(239,68,68,.35);
    }
    .ghost{background:rgba(255,255,255,.04)}

    .grid{margin-top:14px; display:grid; grid-template-columns: 1fr; gap:14px;}
    @media(min-width:980px){ .grid{grid-template-columns: 1.15fr .85fr;} }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,27,46,.92), rgba(15,23,42,.88));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 14px 10px;
      font-size:15px; letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .sub{font-size:12px; color:var(--muted); font-weight:700}
    .content{padding:14px}
    .row{display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:10px}
    @media(min-width:640px){ .row.two{grid-template-columns:1fr 1fr} }
    @media(min-width:780px){ .row.three{grid-template-columns:1fr 1fr 1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input,select,textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .small{font-size:12px; color:var(--muted)}

    /* Checklist items */
    .checklist{display:grid; grid-template-columns:1fr; gap:10px;}
    .item{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      border-radius:var(--r2);
      padding:10px;
    }
    .itemTop{display:flex; gap:10px; align-items:flex-start;}
    .itemTop input[type="checkbox"]{width:18px; height:18px; margin-top:2px; accent-color: var(--ok);}
    .itemTitle{font-weight:950; font-size:13px; margin:0;}
    .itemHelp{margin:2px 0 0; font-size:12px; color:var(--muted);}
    .miniRow{margin-top:8px; display:grid; grid-template-columns:1fr; gap:8px;}
    @media(min-width:680px){ .miniRow.two{grid-template-columns:1fr 1fr} }

    /* Photos */
    .photoGrid{display:grid; grid-template-columns:1fr; gap:10px;}
    @media(min-width:640px){ .photoGrid{grid-template-columns:1fr 1fr;} }
    .photoBox{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px;
    }
    .photoTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;}
    .photoTop .name{font-weight:950; font-size:13px}
    .thumb{
      width:100%;
      aspect-ratio: 4 / 3;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:none;}
    .thumb .placeholder{color:rgba(238,242,255,.55); font-size:12px; padding:10px; text-align:center;}

    /* ====== Report Preview (dark) ====== */
    .reportWrap{padding:14px}
    .reportPreview{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(18,27,46,.94), rgba(15,23,42,.90));
      border-radius:var(--r);
      padding:18px;
    }
    .reportHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding-bottom:12px; margin-bottom:12px;
      border-bottom:1px solid rgba(255,255,255,.12);
      flex-wrap:wrap;
    }
    .reportHeader h3{margin:0; font-size:16px}
    .reportHeader .tag{font-size:12px; color:var(--muted); margin-top:3px}
    .reportBox{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
    }
    .reportBox h4{margin:0 0 8px; font-size:12px; color:var(--muted); letter-spacing:.2px}
    .reportText{
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.4;
      font-size:14px;
      color:rgba(238,242,255,.94);
    }
    .reportGrid2{display:grid; grid-template-columns:1fr; gap:12px;}
    @media(min-width:720px){ .reportGrid2{ grid-template-columns:1fr 1fr; } }

    /* ====== Export host (PHONE FRIENDLY) ====== */
    .exportHost{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 1080px;      /* ✅ narrower so iMessage doesn’t shrink it as much */
      padding: 18px;
      background: transparent;
      z-index: -1;
    }

    /* ====== Export-only CLEAN WHITE theme (BIGGER TEXT) ====== */
    .exportTheme{
      width: 1080px;      /* ✅ match host width */
      background: #ffffff !important;
      color: #0b1220 !important;
      border: 1px solid rgba(10,20,40,.12) !important;
      box-shadow: none !important;
    }
    .exportTheme *{ color: inherit !important; }

    /* ✅ Force single-column for export */
    .exportTheme .reportGrid2{
      grid-template-columns: 1fr !important;
    }

    .exportTheme .reportHeader{
      border-bottom: 2px solid rgba(10,20,40,.10) !important;
      padding-bottom: 14px !important;
      margin-bottom: 14px !important;
    }
    .exportTheme .reportHeader h3{
      font-size: 30px !important;
      letter-spacing: .2px !important;
    }
    .exportTheme .reportHeader .tag{
      font-size: 18px !important;
      color: rgba(10,20,40,.72) !important;
    }
    .exportTheme .reportBox{
      background: #ffffff !important;
      border: 1px solid rgba(10,20,40,.10) !important;
      padding: 14px !important;
      margin: 12px 0 !important;
    }
    .exportTheme .reportBox h4{
      font-size: 16px !important;
      color: rgba(10,20,40,.70) !important;
      margin-bottom: 10px !important;
    }
    .exportTheme .reportText{
      font-size: 20px !important;
      line-height: 1.6 !important;
      color: #0b1220 !important;
    }
    .exportTheme .photoBox{
      background: #ffffff !important;
      border: 1px solid rgba(10,20,40,.10) !important;
    }
    .exportTheme .thumb{
      border: 1px solid rgba(10,20,40,.12) !important;
      background: #f3f6fb !important;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="mark" title="BF Outdoor Services">BF</div>
        <div class="title">
          <h1>Pool Maintenance Checklist</h1>
          <p>Share Report attaches a clean, phone-friendly report image</p>
        </div>
      </div>

      <div class="actions">
        <button class="primary" id="btnShare" type="button">Share Report</button>
        <button class="danger" id="btnReset" type="button">Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="leftCol">
        <div class="card">
          <h2>Job Info <span class="sub">Customer, site, tech</span></h2>
          <div class="content">
            <div class="row two">
              <div><label>Customer Name</label><input data-k="job.customer" placeholder="Customer name" /></div>
              <div><label>Service Address</label><input data-k="job.address" placeholder="Street, City, State" /></div>
            </div>
            <div class="row three">
              <div><label>Date</label><input data-k="job.date" type="date" /></div>
              <div><label>Time</label><input data-k="job.time" type="time" /></div>
              <div><label>Technician</label><input data-k="job.tech" placeholder="Tech name" /></div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Water Test <span class="sub">Results</span></h2>
          <div class="content">
            <div class="row three">
              <div><label>FC</label><input data-k="water.fc" placeholder="ppm" /></div>
              <div><label>CC</label><input data-k="water.cc" placeholder="ppm" /></div>
              <div><label>pH</label><input data-k="water.ph" placeholder="7.2–7.8" /></div>
            </div>
            <div class="row three">
              <div><label>TA</label><input data-k="water.ta" placeholder="ppm" /></div>
              <div><label>CH</label><input data-k="water.ch" placeholder="ppm" /></div>
              <div><label>CYA</label><input data-k="water.cya" placeholder="ppm" /></div>
            </div>
            <div><label>Adjustments Made</label><textarea data-k="water.adjustments" placeholder="Chemicals/adjustments and notes…"></textarea></div>
          </div>
        </div>

        <div class="card">
          <h2>Tasks <span class="sub">Checked only appear in report</span></h2>
          <div class="content">
            <div class="checklist" id="taskList"></div>
          </div>
        </div>

        <div class="card">
          <h2>Before / After Photos <span class="sub">Optional</span></h2>
          <div class="content">
            <div class="photoGrid">
              <div class="photoBox">
                <div class="photoTop">
                  <div class="name">Before</div>
                  <div class="inlineBtns">
                    <label class="btn ghost" for="beforeFile">Add</label>
                    <button class="ghost" id="beforeClear" type="button">Clear</button>
                  </div>
                </div>
                <input id="beforeFile" type="file" accept="image/*" capture="environment" style="display:none" />
                <div class="thumb">
                  <img id="beforeImg" alt="Before preview" />
                  <div class="placeholder" id="beforePh">No before photo added.</div>
                </div>
              </div>

              <div class="photoBox">
                <div class="photoTop">
                  <div class="name">After</div>
                  <div class="inlineBtns">
                    <label class="btn ghost" for="afterFile">Add</label>
                    <button class="ghost" id="afterClear" type="button">Clear</button>
                  </div>
                </div>
                <input id="afterFile" type="file" accept="image/*" capture="environment" style="display:none" />
                <div class="thumb">
                  <img id="afterImg" alt="After preview" />
                  <div class="placeholder" id="afterPh">No after photo added.</div>
                </div>
              </div>
            </div>
            <div class="divider"></div>
            <div class="small">Photos embed into the report image when present.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="rightCol">
        <div class="card">
          <h2>Report Preview <span class="sub">Export is bigger & white</span></h2>
          <div class="reportWrap">
            <div class="reportPreview" id="reportArea">
              <div class="reportHeader">
                <div>
                  <h3>BF Outdoor Services • Pool Maintenance Report</h3>
                  <div class="tag" id="rpTag">Customer • Date</div>
                </div>
                <div class="tag" id="rpMeta">Generated</div>
              </div>

              <div class="reportGrid2">
                <div class="reportBox">
                  <h4>Customer</h4>
                  <div class="reportText" id="rpCustomer"></div>
                </div>
                <div class="reportBox">
                  <h4>Water Test Results</h4>
                  <div class="reportText" id="rpWater"></div>
                </div>
              </div>

              <div class="reportBox">
                <h4>Completed Tasks (checked only)</h4>
                <div class="reportText" id="rpTasks"></div>
              </div>

              <div class="reportBox">
                <h4>Before / After Photos</h4>
                <div class="photoGrid">
                  <div class="photoBox">
                    <div class="photoTop"><div class="name">Before</div></div>
                    <div class="thumb">
                      <img id="rpBeforeImg" alt="Before in report" />
                      <div class="placeholder" id="rpBeforePh">No before photo.</div>
                    </div>
                  </div>
                  <div class="photoBox">
                    <div class="photoTop"><div class="name">After</div></div>
                    <div class="thumb">
                      <img id="rpAfterImg" alt="After in report" />
                      <div class="placeholder" id="rpAfterPh">No after photo.</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="small" style="margin-top:10px; opacity:.85;">
                As always, thank you for choosing BF Outdoor Services.
              </div>
            </div>

            <div class="divider"></div>
            <div class="small">Share Report attaches a phone-friendly image and uses your exact text.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const TASKS = [
      "Skim surface",
      "Brush walls/steps",
      "Vacuum / robot cycle",
      "Empty skimmer & pump baskets",
      "Backwash / clean filter (if needed)",
      "Pump running / prime OK",
      "Filter PSI normal",
      "Visual leak check"
    ];

    const PHOTO = { before:"", after:"" };

    function pad(n){ return String(n).padStart(2,"0"); }
    function fmtDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function fmtTime(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    function fmtWhen(ts){ const d=new Date(ts); return `${fmtDate(d)} ${fmtTime(d)}`; }

    function safeFileName(s){
      return (s||"").toString().trim()
        .replaceAll(/[^a-zA-Z0-9]+/g,"_")
        .replaceAll(/^_+|_+$/g,"")
        .slice(0,60) || "Customer";
    }

    function setDefaults(){
      const dateEl = document.querySelector('[data-k="job.date"]');
      const timeEl = document.querySelector('[data-k="job.time"]');
      const now = new Date();
      if(dateEl && !dateEl.value) dateEl.value = fmtDate(now);
      if(timeEl && !timeEl.value) timeEl.value = fmtTime(now);
    }

    function renderTasks(){
      const wrap = $("#taskList");
      wrap.innerHTML = "";
      TASKS.forEach((t,i)=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="itemTop">
            <input type="checkbox" data-task="1" id="tsk_${i}" />
            <div style="flex:1">
              <p class="itemTitle">${t}</p>
              <p class="itemHelp">Optional notes can be added in customer notes if needed.</p>
            </div>
          </div>
        `;
        wrap.appendChild(el);
      });
    }

    async function fileToDataUrl(file, maxDim=1600, quality=0.86){
      const bmp = await createImageBitmap(file);
      let { width, height } = bmp;
      const scale = Math.min(1, maxDim / Math.max(width, height));
      width = Math.round(width * scale);
      height = Math.round(height * scale);
      const c = document.createElement("canvas");
      c.width = width; c.height = height;
      c.getContext("2d").drawImage(bmp, 0, 0, width, height);
      return c.toDataURL("image/jpeg", quality);
    }

    function setPhoto(which, dataUrl){
      PHOTO[which] = dataUrl || "";

      const img = document.getElementById(which + "Img");
      const ph  = document.getElementById(which + "Ph");
      if(PHOTO[which]){
        img.src = PHOTO[which]; img.style.display="block"; ph.style.display="none";
      }else{
        img.removeAttribute("src"); img.style.display="none"; ph.style.display="block";
      }

      const rImg = document.getElementById("rp" + (which==="before"?"Before":"After") + "Img");
      const rPh  = document.getElementById("rp" + (which==="before"?"Before":"After") + "Ph");
      if(PHOTO[which]){
        rImg.src = PHOTO[which]; rImg.style.display="block"; rPh.style.display="none";
      }else{
        rImg.removeAttribute("src"); rImg.style.display="none"; rPh.style.display="block";
      }

      syncReport();
    }

    $("#beforeFile").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      setPhoto("before", await fileToDataUrl(f));
      e.target.value="";
    });
    $("#afterFile").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      setPhoto("after", await fileToDataUrl(f));
      e.target.value="";
    });
    $("#beforeClear").addEventListener("click", ()=> setPhoto("before",""));
    $("#afterClear").addEventListener("click", ()=> setPhoto("after",""));

    function collectValue(sel){ return (document.querySelector(sel)?.value || "").trim(); }

    function checkedTaskList(){
      const titles=[];
      $$('#taskList input[type="checkbox"][data-task="1"]:checked').forEach(cb=>{
        const t = cb.closest(".item")?.querySelector(".itemTitle");
        if(t) titles.push(t.textContent.trim());
      });
      return titles;
    }

    function syncReport(){
      const cust = collectValue('[data-k="job.customer"]') || "—";
      const addr = collectValue('[data-k="job.address"]') || "—";
      const date = collectValue('[data-k="job.date"]') || "—";
      const time = collectValue('[data-k="job.time"]');
      const tech = collectValue('[data-k="job.tech"]') || "—";

      $("#rpTag").textContent = `${cust} • ${date}`;
      $("#rpMeta").textContent = `Generated ${fmtWhen(Date.now())}`;

      $("#rpCustomer").textContent =
`Customer: ${cust}
Address: ${addr}
Date/Time: ${date}${time?` ${time}`:""}
Technician: ${tech}`;

      $("#rpWater").textContent =
`FC: ${collectValue('[data-k="water.fc"]') || "—"}    CC: ${collectValue('[data-k="water.cc"]') || "—"}    pH: ${collectValue('[data-k="water.ph"]') || "—"}
TA: ${collectValue('[data-k="water.ta"]') || "—"}    CH: ${collectValue('[data-k="water.ch"]') || "—"}    CYA: ${collectValue('[data-k="water.cya"]') || "—"}

Adjustments Made:
${collectValue('[data-k="water.adjustments"]') || "—"}`;

      const tasks = checkedTaskList();
      $("#rpTasks").textContent = tasks.length ? tasks.map(t=>`• ${t}`).join("\n") : "—";
    }

    async function captureReportBlob(){
      syncReport();

      const source = document.getElementById("reportArea");
      const host = document.createElement("div");
      host.className = "exportHost";
      document.body.appendChild(host);

      const clone = source.cloneNode(true);
      clone.classList.add("exportTheme"); // ✅ white + big text + single column
      host.appendChild(clone);

      await new Promise(r=>setTimeout(r, 140));

      const canvas = await html2canvas(clone, {
        backgroundColor: "#ffffff",
        scale: 2,
        useCORS: true
      });

      host.remove();

      return new Promise((resolve, reject)=>{
        canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error("toBlob failed")), "image/png");
      });
    }

    async function shareReport(){
      const date = collectValue('[data-k="job.date"]') || fmtDate(new Date());
      const customer = safeFileName(collectValue('[data-k="job.customer"]') || "Customer");
      const filename = `BF_Pool_Report_${customer}_${date}.png`;

      const message =
`BF Outdoor Services • Pool Maintenance Report
Date: ${date}

Please review the attached report from today’s service, and as always thank you for choosing BF Outdoor Services.`;

      try{
        const blob = await captureReportBlob();
        const file = new File([blob], filename, { type:"image/png" });

        if(navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
          await navigator.share({ title:"Pool Maintenance Report", text: message, files:[file] });
          return;
        }

        const url = URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url; a.download=filename;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        alert("This browser can’t share files. The report image was downloaded instead.");
      }catch{
        alert("Share canceled or unavailable.");
      }
    }

    function resetForm(){
      $$("input, textarea, select").forEach(el=>{
        if(el.type==="checkbox") el.checked=false;
        else el.value="";
      });
      setPhoto("before","");
      setPhoto("after","");
      setDefaults();
      syncReport();
    }

    document.addEventListener("input", (e)=>{ if(e.target.matches("input,textarea,select")) syncReport(); });
    document.addEventListener("change", (e)=>{ if(e.target.matches("input,textarea,select")) syncReport(); });

    $("#btnShare").addEventListener("click", shareReport);
    $("#btnReset").addEventListener("click", resetForm);

    // Init
    setDefaults();
    renderTasks();
    syncReport();
  </script>
</body>
</html>
